
# Project Data
PROJECT_NAME=avdl
PROJECT_VERSION=1.0.0

EXECUTABLE=${PROJECT_NAME}

# Engine Data
ENGINE_PATH=engines/cengine
ENGINE_OUT=${ENGINE_PATH}/build/libavdl-cengine.a

INSTALL_LOCATION=@INSTALL_LOCATION@

# Files for compilation
SRC=$(wildcard src/*.c)

YACC_SRC=yacc.tab.c
YACC_HEADER=yacc.tab.h
LEX_SRC=lex.yy.c

# android
DIRECTORIES=engines/android/app/src/main/cpp/engine/
CENGINE_FILES_HEADER=$(wildcard engines/cengine/include/*.h)
CENGINE_FILES_SRC=$(wildcard engines/cengine/src/*.c)
CENGINE_FILES_ANDROID_HEADER=$(CENGINE_FILES_HEADER:engines/cengine/include/%.h=engines/android/app/src/main/cpp/engine/%.h)
CENGINE_FILES_ANDROID_SRC=$(CENGINE_FILES_SRC:engines/cengine/src/%.c=engines/android/app/src/main/cpp/engine/%.c)
CENGINE_FILES_LOCAL=$(CENGINE_FILES_SRC:engines/cengine/src/%.c=engine\/%.c)

# build the executable, depends on source, lex, yacc and all engines
${EXECUTABLE}: ${DIRECTORIES} ${SRC} ${YACC_SRC} ${YACC_HEADER} ${LEX_SRC} ${CENGINE_FILES_ANDROID_HEADER} ${CENGINE_FILES_ANDROID_SRC} engines/android/app/src/main/cpp/CMakeLists.txt
	gcc -Wall -Wpedantic -Wextra -DINSTALL_LOCATION=\"${INSTALL_LOCATION}/usr\" \
		-DPROJECT_NAME=\"${PROJECT_NAME}\" -Iinclude -I. ${SRC} ${YACC_SRC} ${LEX_SRC} -o ${EXECUTABLE}

# how to build lex
${LEX_SRC}: src/lex.l
	flex src/lex.l

# how to build yacc
${YACC_SRC} ${YACC_HEADER}: src/yacc.y
	bison -d src/yacc.y

# how to build the c engine
engine:
	${MAKE} -C ${ENGINE_PATH}

install: ${EXECUTABLE}# ${ENGINE_PATH}/${ENGINE}
	${MAKE} -C ${ENGINE_PATH} PREFIX=${INSTALL_LOCATION} install
	mkdir -p ${INSTALL_LOCATION}/usr/bin
	install ${EXECUTABLE} ${INSTALL_LOCATION}/usr/bin/
	#mkdir -p ${INSTALL_LOCATION}/share/${PROJECT_NAME}
	#install ${ENGINE_PATH}/${ENGINE} ${INSTALL_LOCATION}/share/${PROJECT_NAME}/${ENGINE}
	#install ${ENGINE_PATH}/index.html ${INSTALL_LOCATION}/share/${PROJECT_NAME}/index.html
	mkdir -p ${INSTALL_LOCATION}/usr/share/man/man1/
	install manual/avdl.1 ${INSTALL_LOCATION}/usr/share/man/man1/
	#mkdir -p ${INSTALL_LOCATION}/share/info/
	#install avdl.info.gz ${INSTALL_LOCATION}/share/info/
	# vim files
	#mkdir -p ${INSTALL_LOCATION}/share/vim/vimfiles/syntax/
	#install vim/syntax/avdl.vim ${INSTALL_LOCATION}/share/vim/vimfiles/syntax/
	#mkdir -p ${INSTALL_LOCATION}/share/vim/vimfiles/ftdetect/
	#install vim/ftdetect/avdl.vim ${INSTALL_LOCATION}/share/vim/vimfiles/ftdetect/
	mkdir -p ${INSTALL_LOCATION}/usr/share/avdl/android
	cp -r engines/android/* ${INSTALL_LOCATION}/usr/share/avdl/android

tarball: ${PROJECT_NAME}.tar

${PROJECT_NAME}.tar:
	tar cf $@ src makefile engines include

clean:
	rm -f ${EXECUTABLE} ${LEX_SRC} ${YACC_SRC} ${YACC_HEADER}

destclean: clean
	rm -f avdl.info.gz makefile

# android files
engines/android/app/src/main/cpp/engine/%.h: engines/cengine/include/%.h
	cp $< $@

engines/android/app/src/main/cpp/engine/%.c: engines/cengine/src/%.c
	cp $< $@

engines/android/app/src/main/cpp/CMakeLists.txt: engines/android/app/src/main/cpp/CMakeLists.txt.in
	sed 's/%AVDL_ENGINE_FILES%/${CENGINE_FILES_LOCAL}/' $< > $@

${DIRECTORIES}:
	mkdir -p $@


.PHONY: clean destclean install engine
